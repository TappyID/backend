version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: tappyone
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  backend:
    build: .
    image: backend-backend
    ports:
      - "8081:8081"
    volumes:
      - ./uploads:/app/uploads
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/tappyone?sslmode=disable
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=tappyone
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - postgres
    restart: unless-stopped
    command: "./main"

  waha:
    image: devlikeapro/waha-plus:chrome
    ports:
      - "3001:3000"
    environment:
      - WAHA_API_KEY=tappyone-waha-2024-secretkey
      - WAHA_API_PORT=3001
      - WAHA_AUTO_START_DELAY_SECONDS=1
      - WAHA_DASHBOARD_ENABLED=true
      - WAHA_DASHBOARD_URL=http://159.65.34.199:3001/dashboard
      - WAHA_GOWS_PATH=/app/gows
      - WAHA_GOWS_SOCKET=/tmp/gows.sock
      - WAHA_MEDIA_POSTGRESQL_URL=postgresql://neondb_owner:npg_QGpk9iyaf2Jx@ep-wispy-sky-aclylzdt-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
      - WAHA_MEDIA_STORAGE=POSTGRESQL
      - WAHA_PRINT_QR=true
      - WAHA_WORKER_ID=tappyone-server
      - WAHA_ZIPPER=ZIPUNZIP
      - WHATSAPP_API_SCHEMA=http
      - WHATSAPP_DEFAULT_ENGINE=GOWS
      - WHATSAPP_HOOK_EVENTS=message,session.status
      - WHATSAPP_HOOK_URL=http://159.65.34.199:8081/webhooks/whatsapp
      - WHATSAPP_RESTART_ALL_SESSIONS=true
      - WHATSAPP_SWAGGER_DESCRIPTION=<p><strong>TappyOne CRM</strong> - Sistema completo de gest√£o via WhatsApp.<br/><a href='https://crm.tappy.id'>Acesse nossa plataforma</a></p>
      - WHATSAPP_SWAGGER_EXTERNAL_DOC_URL=https://crm.tappy.id
      - WHATSAPP_SWAGGER_TITLE=TappyOne CRM API
      - NODE_OPTIONS=--max-old-space-size=16384
      - CHOKIDAR_INTERVAL=5000 
      - CHOKIDAR_USEPOLLING=1
      - UV_THREADPOOL_SIZE=8
    restart: unless-stopped

volumes:
  postgres_data:
